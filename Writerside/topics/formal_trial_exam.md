テスト結果: https://docs.google.com/forms/d/e/1FAIpQLSc_67KaPnNwQrLZ7kuhw-aubz7gMAwY6DQwRJYcW0qlG-iajA/viewscore?hl=ja&hl=ja&viewscore=AE0zAgBYqBjSFS4TuT-3aWHW4ROpLaTvyNafoQileBzin9Q3XBIcNBRHMDlZOjuji_piwAU
模擬試験: https://blog.framinal.life/entry/2022/03/17/214311

ref: https://qiita.com/ntoreg/items/74aa6de2f8f29b4a3b79

# GKE

## クラスタ

Nodeの集合

## Node

Dockerが動くマシンのこと
マスターノードとワーカーノードがある

## Pod

コンテナを配置する入れ物
この単位でスケールさせる

## Service

Pod（コンテナ）と通信を維持するためのポリシーなどを定義するもの
内部も外部も

- ClusterIP
- NodePort
- LoadBalancer

## Ingress

外部のロードバランサーの役割(実態はCloud Load Balancer)
外部からのアクセスを受け付ける

External HTTPS Load Balancer に複数のホスト名用の SSl/TLS 証明書を 設定する方法

- Google マネージド SSL 証明書。使用方法については、マネージド証明書のページをご覧ください。
- ご自身で管理している Google Cloud SSL 証明書。以前に Google Cloud プロジェクトにアップロードされた事前共有証明書を使用します。
- Kubernetes Secrets。Secret では、ご自身で作成した証明書と鍵が保持されます。Secret を使用するには、その名前を Ingress マニフェストの tls フィールドに追加します。


## ReplicaSet

Podがいくつ起動させるかを定義するもの
Podの上位概念

## Deployment

デプロイを司る機能
ReplicaSetとPodのセットをdeployする

## Secret

安全に鍵情報を保存し、Pod 内に反映させることができる

## マルチゾーンクラスタ

複数のゾーンにまたがってクラスタを構成すること

## リージョンクラスタ

複数のリージョンにまたがってクラスタを構成すること
マスターノードをゾーンごとに持つことで、マルチゾーンクラスタよりも可用性を高めている

## オートスケール

2種類存在する
Podの数を水平オートスケールさせる方法(すぐ立ち上がる, Nodeのリソース分だけしか増えない)
Nodeの数を増やす方法(時間がかかる)

## Network Policy

クラスタ内で相互にアクセスできる Pod と Service を決定する Pod レベルのファイアウォール ルールを作成
Pod間の通信を制御

## Authorization Policy

Kubernetes Pod には一時的な IP が割り振られるため、従来の IP ベースのファイアウォール ルールでは、ワークロード間のアクセスを十分に保護することができない
アプリケーション（L7）レイヤおよびトランスポート（L3 / 4）レイヤのワークロードに対するアクセス制御を有効にできる
認可ポリシーを構成して、サービスまたはユーザーが行える内容についての権限を指定できる

Service間の通信を制御
ポリシーの範囲は、サービス メッシュ全体、名前空間、または個々のワークロードに適用できます。

## Google Cloudサービスへの認証

### 第一はIdentity workload

Cloud IAM で作成した "Google Cloud の" サービスアカウントと Kubernetes リソースとして作成した "Kubernetes の" サービス アカウントを紐づけることができる
オンプレミスに存在するデータベースへの認証などのために ID ・パスワードが必要とされる場面もある

### Compute Engineのサービスアカウントを使用する

Nodeの実態はCompute EngineのVMなので、Compute Engineのサービスアカウントを使用することができる
必要な Google Cloud サービスを使用する権限がない場合がある

### Kubernetes secretを使用

アプリケーションのサービス アカウントを作成し、その認証キーを Kubernetes Secretとして保存する

## 認証情報を管理

DBなどの認証情報の保持

### Secret Managerに保存

Secret Managerに秘匿情報を保存し、GKEからはサービスアカウントを使用して、Secret Managerにアクセスすることで認証情報を取得できる

# Cloud KMS と Secret Managerの違い

Cloud KMSは暗号鍵を管理するサービス
Secret Managerは秘匿情報を管理するサービス(データベースパスワードやAPIキーなど)

# mTLS(相互TLS認証)

ネットワーク接続の両端にいる当事者がお互いに正しい秘密鍵を持っていることを確認することで、彼らが主張する人物であることを保証
ゼロトラストネットワークの構築に使用される

## 従来のTLS

サーバーのみが秘密鍵と証明書を保持しており、クライアントはサーバーの証明書を検証することで、サーバーが正しいことを確認していた

## mTLSの場合

クライアントも秘密鍵と証明書を保持しており、クライアントが正しいことをサーバーが確認することで、クライアントが正しいことを確認する

# サービスメッシュ

アプリケーションのさまざまな部分が互いにデータをどのように共有するかを制御する方法
インフラ側で制御する

サービス間の通信を規定するロジックを個々のサービスから抜き出して、インフラレイヤーで制御する

通信部分をプロキシコンテナとして抜き出す(サイドカーコンテナ)
通信は、このプロキシコンテナのみが行い、すべてのPodに対して適用される
-> Mesh上に広がる

# Cloud Storage 保持ポリシー

保持ポリシーを設定でき、保持期間を指定することができる
保持期間中は、削除や変更ができない

# Cloud Runにおけるログの出力

Cloud Runでは、標準出力と標準エラー出力のログを出力することができる

# Serverless VPC Access

Cloud Run や Cloud Functions, App Engine から VPC 内のリソースにアクセスするための機能
コネクタとそれを利用するサーバーレスは同じリージョンに存在する必要がある
  - 接続したい VPC リソースとコネクタが同じリージョンである必要は無い

ref: https://cloud.google.com/vpc/images/serverless-vpc-access.svg

# 永続ディスク

読み書き1回、読み取り複数回が可能

# Cloud Trace

- トレース収集：アプリケーションが行う各リクエストの経路をトラッキングし、それらのトレースデータを収集します。
- パフォーマンス分析情報：各エンドポイントのトレース結果を自動的に評価し、パフォーマンスのボトルネックを検出します。
- 自動分析：トレース対象のアプリケーションごとに、日々のパフォーマンスレポートが自動的に作成されます。必要に応じて、任意のカスタムレポートも作成することができます。
- レイテンシの変化の検出：アプリケーションのパフォーマンスレポートを時系列で評価し、アプリケーションのレイテンシの悪化を特定します。

## X-Cloud-Trace-Context

Cloud Trace で使用されるヘッダー
リクエストの親子関係を追跡することができる

リクエストログとコンテナログを紐づけることができる

# ログの種類

- リクエストログ（サービスのみ）
  - Cloud Run サービスに送信されたリクエストのログ。これらのログは自動的に作成されます。
- コンテナログ（サービスとジョブ）
  - インスタンス（通常は独自のコード）から出力されたログです。コンテナログを作成するで説明されているように、サポートされているロケーションに書き込まれます。

# Pub/Sub

- パブリッシャー（プロデューサー）: 特定のトピックに関するメッセージを作成してメッセージ サービスに送信（パブリッシュ）します。
- メッセージ: サービスを通って移動するデータ。
- トピック: メッセージのフィードを示す名前付きエンティティ。
- スキーマ: Pub/Sub メッセージのデータ形式を管理する名前付きエンティティ。
- サブスクリプション: 特定のトピックに関するメッセージの受信に関心があることを示す名前付きエンティティ。
- サブスクライバー（コンシューマー）: 特定のサブスクリプションに関するメッセージを受信します。

# GOOGLE_APPLICATION_CREDENTIALS

現在のシェルセッションでのみ有効な環境変数
アクセストークンが保存されているファイル名を指定する必要がある

# メタデータサーバー

Cloud Runで使用される
プロジェクト ID、リージョン、インスタンス ID、サービス アカウントなどコンテナに関する情報を取得するために使用できる
ランタイムのサービスアカウントのトークンを作成することにも利用できる

# VMメタデータ

Compute Engineのインスタンスで使用される
VM からメタデータ サーバーの API にアクセスするのに追加の承認は必要なし

# GKEのオートスケール

GKEで作成したMIGの設定を変更してオートスケールしてはいけない
ノートの数を増減させたい場合には、GKEのクラスタオートスケールでノードプールのサイズを変更するべき

# エラーの出力先

stderrに出力する必要がある
Cloud Error Reportingはstderrのログを収集する

# 複数リージョンでの整合性

Cloud Spannerは可能
Cloud SQLは単一のリージョンのみの整合性のみサポート

# サービスアカウント

サービスに割り当てられるアカウント
Googleアカウントは人に割り当てる

ref: https://cloud.google.com/iam/docs/service-account-overview?hl=ja

# Google アカウント

Cloud Identity によって管理される

# IAMロール

権限をまとめたもの

基本ロール
  - オーナー
  - 編集者
  - 閲覧者
事前定義ロール
カスタムロール

# ポリシー

メンバーとロールを紐づけることをバインディング
このバインディングをまとめたものをポリシーという

# Cloud IAP

Identity-Aware Proxy
アプリケーションに対して認証を行うプロキシサーバー(フルマネジド)

ref: https://blog.g-gen.co.jp/entry/login-your-vm-with-iap